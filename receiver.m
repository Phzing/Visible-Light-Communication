M = [2.1803   -0.1933   -0.0915;
   -0.4312    1.8275   -0.2123;
    0.3308   -0.9827    1.6836];

% M = [2.0434   -0.1262   -0.0530;
%    -0.5058    1.6916   -0.2222;
%     0.3151   -0.9250    1.6194]; % for 4 levels

[bits, dat] = decoder('2025-05-05 18.42_video.tif', 64, M);

%bits = [bits, num2str(ones(1,10*1104))];
%bits = strrep(bits, ' ','');

% 1) The folder containing bits_to_msg.py
folder = 'C:\Users\g.m.herman\Downloads';

% 2) Make sure it’s on Python’s search path
if count(py.sys.path, folder) == 0
    % insert at front so it takes precedence
    py.sys.path().insert(int32(0), folder);
end

% 3) Now import your module
mod = py.importlib.import_module('bits_to_msg'); 
mod_img = py.importlib.import_module('bits_to_img');  % Make sure it's in your Python path
mod_img_rs = py.importlib.import_module('bits_to_img_RS_');  % Make sure it's in your Python path

%bits = '0100100100100000011011000110111101110110011001010010000001000101010100110100010100100000001100110011010100110001001011100010000001001100011011110111001001100101011011010010000001101001011100000111001101110101011011010010000001100100011011110110110001101111011100100010000001110011011010010111010000100000011000010110110101100101011101000010110000100000011000110110111101101110011100110110010101100011011101000110010101110100011101010111001000100000011000010110010001101001011100000110100101110011011000110110100101101110011001110010000001100101011011000110100101110100001011000010000001110011011001010110010000100000011001000110111100100000011001010110100101110101011100110110110101101111011001000010000001110100011001010110110101110000011011110111001000100000011010010110111001100011011010010110010001101001011001000111010101101110011101000010000001110101011101000010000001101100011000010110001001101111011100100110010100100000011001010111010000100000011001000110111101101100011011110111001001100101001000000110110101100001011001110110111001100001001000000110000101101100011010010111000101110101011000010010111000100000010101010111010000100000011001010110111001101001011011010010000001100001011001000010000001101101011010010110111001101001011011010010000001110110011001010110111001101001011000010110110100101100001000000111000101110101011010010111001100100000011011100110111101110011011101000111001001110101011001000010000001100101011110000110010101110010011000110110100101110100011000010111010001101001011011110110111000100000011101010110110001101100011000010110110101100011011011110010000001101100011000010110001001101111011100100110100101110011001000000110111001101001011100110110100100100000011101010111010000100000011000010110110001101001011100010111010101101001011100000010000011000100011100111001110111111011111000010010100001011101110110111011000010101000101111101101000011011100100111011011000001100001010001010011101111010010110010111110100111011100001100000111111101100010101001001000000110000101100010010110001101111111010000000110010101111000001000000110010101100001001000000110001101101111011011010110110101101111011001000110111100100000011000110110111101101110011100110110010101110001011101010110000101110100001011100010000001000100011101010110100101110011001000000110000101110101011101000110010100100000011010010111001001110101011100100110010100100000011001000110111101101100011011110111001000100000011010010110111000100000011100100110010101110000011100100110010101101000011001010110111001100100011001010111001001101001011101000010000001101001011011100010000001110110011011110110110001110101011100000111010001100001011101000110010100100000011101100110010101101100011010010111010000100000011001010111001101110011011001010010000001100011011010010110110001101100011101010110110100100000011001000110111101101100011011110111001001100101001000000110010101110101001000000110011001110101011001110110100101100001011101000010000001101110011101010110110001101100011000010010000001110000011000010111001001101001011000010111010001110101011100100010111000100000010001010111100001100011011001010111000001110100011001010111010101110010001000000111001101101001011011100111010000100000011011110110001101100011011000010110010101100011011000010111010000100000011000110111010101110000011010010110010001100001011101000110000101110100001000000110111001101111011011100010000001110000011100100110111101101001011001000110010101101110011101000010110000100000011100110111010101101110011101000010000001101001011011100010000001100011011101010110110001110000011000010010000001110001011101010110100100100000011011110110011001100110011010010110001101101001011000010010000001100100011001010111001101100101011100100111010101101110011101000010000001101101011011110110110001101100011010010111010000100000011000010110111001101001011011010010000011011110110101110010010101100010010111110101101100010111111001001101001101101101101000111001111011011000001110001101111001001110011011101010101110000101111101001001001010010110111011010001111110111000110010001011111111110100010000010100011010100010101010100110100101100100001000000110010101110011011101000010000001101100011000010110001001101111011100100111010101101101001011101110110100001100111010100001110000101100011110011001111000000001001001100000111110110011011001100111001000000011110001000111001011000111011101101101001010000001000110011001100110110010011111010110000111100001110110011100101001100010101001111100101011111100';
% 4) Call the function
%result = mod_img.bits_to_msg(bits);
%disp(result);

width = int32(102); height = int32(88);
mod_img_rs.bitstream_image_RS_comparison(bits, width, height, "reconstructed.png");
img = imread("reconstructed.png");
img2 = imread("corrected_reconstructed.png");
figure();
imshow(img);
figure()
imshow(img2);



function [bits, dat] = decoder(file, num_columns, M)
    ROItimeSeries = GridROIs2timeSeries(file);
    dat = extract_and_average_frames_dualclock(ROItimeSeries, num_columns);
    bits = final_decoder(dat(:,2:end-1,:), num_columns, M);
end